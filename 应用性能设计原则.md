# 应用性能设计原则



## 1.考虑使用分布式缓存原则

1.1设计cache集群化部署，集中更新缓存带来性能和资源开销；如果cache失效，大量请求命中DB带来服务性能雪崩，避免丢失过多数据造成服务压力陡增。避免单点问题，提供更加高可用，高性能的服务。

1.2 设计热点数据进行预热加载：高峰期来临前，将热点数据提前存入缓存，提高高峰期的服务性能。

1.3 不存在的数据并定期清理：防止查询不到，导致cache无法命中而频繁访问DB的场景

1.4 分布式缓存集中管理，保证可扩展性，降低系统复杂度



## 2.考虑异步化设计原则

通过分布式消息队列来实现削峰的目的，通过业务配合技术来解决问题。一般合理使用消息队列，可有效抵御促销活动大量涌入的订单对系统造成的冲击



## 3. 考虑集群策略原则

使用负载均衡技术为一个应用构建一个由多台服务器组成的服务器集群，将并发请求分发到多台服务器上处理，避免单一服务器因负载压力过大而响应缓慢，使用户请求具有更好的响应延迟特性



## 4.代码性能优化原则

4.1 多线程中的密集型计算：线程数不宜超过CPU核数。如果是IO处理，则线程数=[任务执行时间/(任务执行时间-IO等待时间)] * CPU核数

4.2将对象设计成无状态对象，多采用局部对象，并发访问资源时使用锁

4.3 资源复用原则：系统运行时，尽量减少那些开销很大的资源的创建和销毁

4.4合理设置JVM参数，以最大程度避免不合理的full gc



## 5.存储性能优化原则

5.1 硬件选择——机械硬盘VS固态硬盘

5.2 B+树 vs LSM树（数据结构）：关系型数据库的索引采用B+树进行实现，nosql数据库采用了LSM树进行存储。所以对于读写操作较多，LSM树其性能远高于b+树

5.3 存储和备份方式选择（RAID vs HDFS），采用HDFS结合map reduce进行海量数据存储和分析，能自动进行并发访问和冗余备份，具有很高的可靠性



# 一致性

在业务系统中，数据一致性非常的重要，总体上说，有2种方式来保证一致性

- 事务性的强一致性
- 数据的最终一致性



- 事务性的强一致性

事务性的强一致，实施的代价比较高，基本局限于服务应用内部，并且一个应用如果事务太多，比如降低并发性，增加数据库的负载；如果在分布式情况下，要实现事务一致性，还需要引入复杂的分布式事务解决方案；所以，不建议一般的业务系统采用事务一致性方案，只对资金类要求很严格的业务有限使用。



- 数据的最终一致性

数据的最终一致性，需要处理好几个问题

1. 业务调用的幂等处理
2. 业务失败的重试（补偿）处理
3. 业务异步处理的握手处理
4. 数据不一致的检测和报警



前3个步骤是保证一致性的关键，需要开发在开发过程中重点把握；第4个步骤是事后止损措施。



要求：

- 明确系统内部哪些数据需要一致
- 明确系统和外部系统之间哪些数据需要保持数据一致性
- 保证数据一致的策略和实现方式



# 可靠性

**I.避免单点（重要）**：集群+LB、容器化部署(k8s的编排管理保证了pod的数量和健康,并且支持弹性伸缩、滚动升级)

**II.熔断**：快速失败，避免服务雪崩，保护整个服务链路；（dubbo+hystrix）

**III.降级**： 不同的业务采用不同的降级逻辑，保证核心服务的正常运行；（在dubbo消费端可以配置mock对调用进行降级）

**IV.限流**： 防止流量超出系统所能承受的阈值；（sentinel）

**V.缓存**： 避免同一时间大量请求直接落到数据库，将数据库击垮；（本地缓存、分布式缓存）

**VI.超时和重试机制**： 设置超时时间避免请求堆积，重试避免偶尔的网络抖动；（配置dubbo的timeout和retry次数，注意服务接口的幂等）



## 一、什么时候需要读写分离？



- 高频读，低频写
- 读请求单节点数据库性能难以支撑（通常每秒QPS吞吐量可能超过3w，IOPS超过2w，建议考虑）
- 读请求有弹性伸缩的要求（是否需要高峰扩容，闲时回收）
- 缓存存在的情况下，仍旧可能因为命中率，首次加载等场景，存在集中查询的场合



## 二、读写分离前提



- 对主从同步导致性能的少量下降有一定的容忍性（性能：同步复制<半同步复制<异步复制）
- 对主从分离的数据可见性延迟有一定的容忍性
- 对业务中读取后更新等场景有严格的把控评估和解决方案
- 对代码中可读写分离的功能有明确的把控
- 事务中查询不应读写分离
- 读写分离可能加剧业务脏写问题，因此从根本上规避此类问题接入读写分离的系统应当有数据写入一致性方案，例如version版本控制



## 三、读写分离方案



1. 阿里云数据库读写分离方案：

https://help.aliyun.com/document_detail/96073.html?spm=a2c4g.11186623.2.13.54582e9bkHFr2j#concept-ptl-fl4-wdb



1. ShardingJDBC及ShardingProxy：

https://shardingsphere.apache.org/document/current/en/features/replica-query/



1. 业务系统实现可控读写分离

自行实现



## 四、方案比较

|               | 阿里云数据库读写分离                                         | 数据库中间件    | 业务系统实现读写分离                     |
| ------------- | ------------------------------------------------------------ | --------------- | ---------------------------------------- |
| 部署方式      | 仅公有云                                                     | 公有云/专有云   | 公有云/专有云                            |
| 代码耦合      | 无侵入/标记侵入                                              | 无侵入/标记侵入 | 标记侵入/强耦合                          |
| 可控性        | 自动分发：代理层通过SELECT及UPDATE关键字自动分发，业务不可控标记分发：通过force hint标记分发控制，对业务有侵入控制 | 同左            | 业务完全控制，指定本次查询是读库或者写库 |
| 事务          | 不支持事务                                                   | 不支持事务      | 不支持事务                               |
| 可用区/多中心 | 不支持，读写节点不可跨可用区                                 | 支持            | 支持                                     |



## 一、什么时候需要分库分表

- 预估单表记录数大于500w，且可能持续增长
- 预估单库容量大于1TB，且可能持续增长
- 预估单库或者单表存在读写热点问题，尤其是写热点问题
- 预估存在多中心场合



## 二、分库分表的作用

- 水平扩展，理论上数据库容量无限扩展
- 热点分散，合理设计分表，缓解单表中频繁访问，行锁及I/O争抢的问题
- 易于维护，单表DDL可操作，不因为表体积过大导致无法维护
- 提升性能，相较大体积表，即使表上出现skip等耗时操作，仍旧可以等待响应，不至于挂起
- 多中心部署技术路径必须项



## 三、分库分表方案

### 1. 设计分片键及分片策略

1. 1. 考虑最频繁查询业务字段，且全局唯一（真正的全局唯一，支持多中心架构）
   2. 分片策略下，预估单表容量大小
2. 1. 分片策略下，预估单表查询热度



### 2. 动态分片 or 静态分片

|          | 静态分片                                                     | 动态分片                                                   |
| -------- | ------------------------------------------------------------ | ---------------------------------------------------------- |
| 分片算法 | Hash等取模法                                                 | 时间片算法，雪花算法，范围算法，检索表等                   |
| 节点数   | 预设固定                                                     | 执行中可变                                                 |
| 节点变化 | 成本极大，需数据迁移重排                                     | 可适应算法变更                                             |
| 单点查询 | 性能极好                                                     | 根据算法不同，理论上最好情况可达静态分片同等性能           |
| 跨表查询 | 少量分片无需构建索引表分片数较多需要构建索引表或者其他数据整合方案 | 需要构建动态索引表或者其他数据整合方案                     |
| 跨库分片 | 跨库算法和跨表算法可以与业务无关                             | 跨库算法和跨表算法需要根据业务设计                         |
| 维护性   | 较差，无法直观获知数据位于哪个分片中                         | 可设计，可以通过算法将分片信息维护于分片键本身或者检索表中 |



### 3. 跨表业务查询方案设计

需要考虑业务跨表数据连接、查询和排序等场景。设计全局静态索引表，或者数据聚合查询方案（例如ElasticSearch等）



### 4. 维护可行性

- 数据迁移可行性
- 分片重排可行性
- 数据聚合可行性

\### 

## 四、可执行参考方案

### 1. 阿里云集群数据库

#### 1.1 PolarDB

PolarDB是阿里云提供的基于计算与存储分离理念设计的原生关系型数据库，其已经提供了大容量存储及读写分离特性，支持最大容量100T，16个计算节点，每节点最高88vCPU（理论值）。

可参考：https://www.aliyun.com/product/polardb?spm=5176.13910061.J_8058803260.128.467830f1cXm7rR



#### 1.2 PolarDB-X（原DRDS，水平分片型）

PolarDB-X是阿里云提供的基于DRDS分布式SQL模型以及X-DB分布式存储设计的云分布式原生关系型数据库，支持PB级存储，峰值8700wTPS（理论值），基于Paxos一致性协议确保跨可用区数据一致性。

可参考：https://www.aliyun.com/product/drds?spm=5176.155538.J_8058803260.129.59baee1fsN3PbW



### 2. 分库分表中间件

#### 2.1 ShardingJDBC 

可参考：https://shardingsphere.apache.org/document/current/en/overview/#shardingsphere-jdbc

#### 2.2 ShardingProxy

可参考：https://shardingsphere.apache.org/document/current/en/overview/#shardingsphere-proxy



|          | shardingJDBC                                     | shardingProxy                          |
| -------- | ------------------------------------------------ | -------------------------------------- |
| 架构     | 分布式无状态设计                                 | 中心式有状态设计                       |
| 性能     | 本地执行，静态算法，性能较好                     | 云服务管理，代理模式，多一跳，性能稍差 |
| 可靠性   | 无单点故障                                       | 有单点故障                             |
| 可运维性 | 节点变更、路由切换存在一致性风险（根据算法决定） | 节点变更代理统一管理，算法保障一致性   |
| 编码     | 引入jar包，配置数据                              | 需要部署独立进程                       |



### 3. 业务定制化分库分表（不推荐）

在一些特殊场合下，可以考虑业务引入定制化分库分表策略。

优点：

1. 1. 数据分布贴近业务，可以最合理设计
   2. 性能可定制
2. 1. 数据可视性较好

缺点：

1. 1. 可运维性差
   2. 需要人力维护成本
2. 1. 后期变更需要完全定制





#### 监控报警



监控事项分为服务监控，业务监控，性能监控。

每类监控需要明确：

- 监控项（服务状态，业务埋点，性能指标等）
- 监控的实现方式（skywalking，metric，日志等）
- 感知方式
- - 定期查看监控页面
  - 报警通知
- - - 报警阈值，通知方式，通知频次等



# 遂昌项目接口设计文档

# ER图

![img](https://cdn.nlark.com/yuque/0/2022/png/12657734/1648612024950-d1d166d5-9073-4d11-bda1-6f78fcbbd5e7.png)

\### 

# 系统架构图

![img](https://cdn.nlark.com/yuque/0/2022/png/12657734/1648708934922-8e0de920-51c5-45c2-9f80-d74f5543c41d.png)

# 天空之城之遂昌大屏项目接口文档

**简介**:天空之城之遂昌大屏项目接口文档

ER图

**天空之城之遂昌大屏项目接口文档**通用设计**大屏监控接口**1、统计给定日期地质灾害和山塘水库预警总数2、统计给定日期以前7天地质灾害和山塘水库预警总数3、统计当日预警事件总数接口4、统计给定日期以前7天预警事件总数5、统计未处理预警监测项类别前4类接口（当日）6、统计预警监测项类别前4类接口（当日）7、查看相关监测项的告警列表接口，列表展示告警信息包括：位置、监测点、预警描述、告警等级，列表滚动展示8、统计红色告警总数、橙色告警总数、黄色告警总数、蓝色告警总数接口（当日）9、统计红色告警已处理数、橙色告警已处理数、黄色告警已处理数、蓝色告警已处理数接口(当日)10、监测对象基本信息接口11、告警信息：告警类型、位置、监测点、预警描述、处置状态接口（当日）12、告警处理详情接口：含测点名称、预警时间、预警等级、监测项、预警描述、是否误报、处理意见、处理人、处理时间13、查询近7日监测点的预警详情接口14、统计近7天，每日红、橙、黄、蓝四级预警数量接口15、统计近七日红色告警已处理数、橙色告警已处理数、黄色告警已处理数、蓝色告警已处理数接口(当日)16、对今天，本周、本月，返回三个巡检次数进行统计；返回巡检结果中正常巡检的百分比（分别计算今日、本周、本月）17、查询当前所有离线设备，并在地图上显示设备名称及位置信息18、查询当日所有的报警监测点（非监测对象），并返回最新的预警信息（如有多条报警信息，返回最后一次报警结果），包括：监测点名称、预警时间、预警等级、监测项、预警描述、处置状态、位置、是否误报、处理意见、处理人、处理时间。19、查询近7日每日某监测项告警事件总数

# 通用设计

因为下面每个接口的查询条件都要根据遂昌县的监测点来过滤数据，所以可以提前把遂昌县的监测对象和监测对象下的监测点一次性获取到，缓存起来。减少每个接口都去关联查询对数据库的压力。

根据监测对象、监测点、监测对象和监测点关系表，一次性查询到相关区域的监测对象和监测点信息，并缓存到内存,目前设置的缓存时间为120秒，

```
SELECT  obj.*,nmp.*FROM (  SELECT id, `type`, nmo.area_code  FROM notice_monitor_object nmo  WHERE nmo.`type` IN ('dzzh','stsk')  AND nmo.area_code = '331123'  AND nmo.is_deleted = 0) AS objLEFT JOIN notice_monitor_object_point_ref nmopr ON obj.id = nmopr.monitor_id and nmopr.is_deleted = 0LEFT JOIN notice_monitor_point nmp ON nmp.code = nmopr.point_code AND nmp.is_deleted = 0        group by point_id
```

# 大屏监控接口

## 1、统计给定日期地质灾害和山塘水库预警总数

**接口地址**:/suichang-monitor/monitor/day-warning

**请求方式**:GET

**请求数据类型**:application/x-www-form-urlencoded

**响应数据类型**:*/*

**接口描述**:<p>统计给定日期地质灾害和山塘水库预警总数，如果日期不传，则返回当天日期的数据</p>

**设计**：根据通用设计拿到地质灾害和山塘水库的监测点ID，然后去监测记录表去查询预警记录总数（单表操作）

**请求参数**:

| **参数名称** | **参数说明**                                   | **请求类型** | **是否必须** | **数据类型** | **schema** |
| ------------ | ---------------------------------------------- | ------------ | ------------ | ------------ | ---------- |
| areaCode     | 行政区划code，默认为遂昌县的area_code          | query        | false        | string       |            |
| date         | 统计的日期，不填默认为当天,日期格式:yyyy-MM-dd | query        | false        | string       |            |

**响应状态**:

| **状态码** | **说明**     | **schema**              |
| ---------- | ------------ | ----------------------- |
| 200        | OK           | 统一结果对象«WarningVO» |
| 401        | Unauthorized |                         |
| 403        | Forbidden    |                         |
| 404        | Not Found    |                         |

**响应参数**:

| **参数名称** | **参数说明**        | **类型**       | **schema**     |
| ------------ | ------------------- | -------------- | -------------- |
| code         | 错误码（200为成功） | integer(int32) | integer(int32) |
| data         | 响应数据对象        | WarningVO      | WarningVO      |
| date         | 统计日期            | string         |                |
| dzzhSum      | 地质灾害预警总数    | integer(int64) |                |
| stskSum      | 山塘水库预警总数    | integer(int64) |                |
| msg          | 提示信息            | string         |                |
| success      | 是否成功            | boolean        |                |

**响应示例**:

{  "code": 200,  "data": {    "date": "0315",    "dzzhSum": 1000,    "stskSum": 1000  },  "msg": "",  "success": true }

## 2、统计给定日期以前7天地质灾害和山塘水库预警总数

**接口地址**:/suichang-monitor/monitor/day7-warning

**请求方式**:GET

**请求数据类型**:application/x-www-form-urlencoded

**响应数据类型**:*/*

**接口描述**:<p>统计给定日期以前7天地质灾害和山塘水库预警总数,如果日期不传则返回当前日期以前7天的数据，包含当天日期</p>

**设计**：根据通用设计拿到地质灾害和山塘水库的监测点ID，然后去监测记录表去查询预警记录总数（单表操作）

**请求参数**:

| **参数名称** | **参数说明**                                   | **请求类型** | **是否必须** | **数据类型** | **schema** |
| ------------ | ---------------------------------------------- | ------------ | ------------ | ------------ | ---------- |
| areaCode     | 行政区划code，默认为遂昌县的area_code          | query        | false        | string       |            |
| date         | 统计的日期，不填默认为当天,日期格式:yyyy-MM-dd | query        | false        | string       |            |

**响应状态**:

| **状态码** | **说明**     | **schema**                    |
| ---------- | ------------ | ----------------------------- |
| 200        | OK           | 统一结果对象«List«WarningVO»» |
| 401        | Unauthorized |                               |
| 403        | Forbidden    |                               |
| 404        | Not Found    |                               |

**响应参数**:

| **参数名称** | **参数说明**        | **类型**       | **schema**     |
| ------------ | ------------------- | -------------- | -------------- |
| code         | 错误码（200为成功） | integer(int32) | integer(int32) |
| data         | 响应数据对象        | array          | WarningVO      |
| date         | 统计日期            | string         |                |
| dzzhSum      | 地质灾害预警总数    | integer(int64) |                |
| stskSum      | 山塘水库预警总数    | integer(int64) |                |
| msg          | 提示信息            | string         |                |
| success      | 是否成功            | boolean        |                |

**响应示例**:

{  "code": 200,  "data": [    {      "date": "0315",      "dzzhSum": 1000,      "stskSum": 1000    }  ],  "msg": "",  "success": true }

## 3、统计当日预警事件总数接口

**接口地址**:/suichang-monitor/monitor/day-event

**请求方式**:GET

**请求数据类型**:application/x-www-form-urlencoded

**响应数据类型**:*/*

**接口描述**:<p>统计当日预警事件总数接口</p>

**设计**：根据通用设计拿到监测点ID，然后去监测记录表去查询预警记录总数（单表操作）

**请求参数**:

| **参数名称** | **参数说明**                                   | **请求类型** | **是否必须** | **数据类型** | **schema** |
| ------------ | ---------------------------------------------- | ------------ | ------------ | ------------ | ---------- |
| areaCode     | 行政区划code，默认为遂昌县的area_code          | query        | false        | string       |            |
| date         | 统计的日期，不填默认为当天,日期格式:yyyy-MM-dd | query        | false        | string       |            |

**响应状态**:

| **状态码** | **说明**     | **schema**            |
| ---------- | ------------ | --------------------- |
| 200        | OK           | 统一结果对象«EventVO» |
| 401        | Unauthorized |                       |
| 403        | Forbidden    |                       |
| 404        | Not Found    |                       |

**响应参数**:

| **参数名称** | **参数说明**        | **类型**       | **schema**     |
| ------------ | ------------------- | -------------- | -------------- |
| code         | 错误码（200为成功） | integer(int32) | integer(int32) |
| data         | 响应数据对象        | EventVO        | EventVO        |
| date         | 事件发生日期        | string         |                |
| doneEventSum | 已处理事件总数      | integer(int64) |                |
| todoEventSum | 待处理事件总数      | integer(int64) |                |
| msg          | 提示信息            | string         |                |
| success      | 是否成功            | boolean        |                |

**响应示例**:

{  "code": 200,  "data": {    "date": "0316",    "doneEventSum": 2000,    "todoEventSum": 2000  },  "msg": "",  "success": true }

## 4、统计给定日期以前7天预警事件总数

**接口地址**:/suichang-monitor/monitor/day7-event

**请求方式**:GET

**请求数据类型**:application/x-www-form-urlencoded

**响应数据类型**:*/*

**接口描述**:<p>统计给定日期以前7天未处理与已处理预警事件总数,如果日期不传则返回当前日期以前7天的数据，包含当天日期</p>

**设计**：根据通用设计拿到监测点ID，然后去监测记录表去查询预警记录总数（单表操作）

**请求参数**:

| **参数名称** | **参数说明**                                   | **请求类型** | **是否必须** | **数据类型** | **schema** |
| ------------ | ---------------------------------------------- | ------------ | ------------ | ------------ | ---------- |
| areaCode     | 行政区划code，默认为遂昌县的area_code          | query        | false        | string       |            |
| date         | 统计的日期，不填默认为当天,日期格式:yyyy-MM-dd | query        | false        | string       |            |

**响应状态**:

| **状态码** | **说明**     | **schema**                  |
| ---------- | ------------ | --------------------------- |
| 200        | OK           | 统一结果对象«List«EventVO»» |
| 401        | Unauthorized |                             |
| 403        | Forbidden    |                             |
| 404        | Not Found    |                             |

**响应参数**:

| **参数名称** | **参数说明**        | **类型**       | **schema**     |
| ------------ | ------------------- | -------------- | -------------- |
| code         | 错误码（200为成功） | integer(int32) | integer(int32) |
| data         | 响应数据对象        | array          | EventVO        |
| date         | 事件发生日期        | string         |                |
| doneEventSum | 已处理事件总数      | integer(int64) |                |
| todoEventSum | 待处理事件总数      | integer(int64) |                |
| msg          | 提示信息            | string         |                |
| success      | 是否成功            | boolean        |                |

**响应示例**:

{  "code": 200,  "data": [    {      "date": "0316",      "doneEventSum": 2000,      "todoEventSum": 2000    }  ],  "msg": "",  "success": true }

## 5、统计未处理预警监测项类别前4类接口（当日）

**接口地址**:/suichang-monitor/monitor/top4-undo-monitor-item

**请求方式**:GET

**请求数据类型**:application/x-www-form-urlencoded

**响应数据类型**:*/*

**接口描述**:<p>统计当日未处理预警监测项数值排名前四监测项名称与数值，按降序排序输出（含地质灾害＋山塘水库）</p>

**设计**：1、根据通用设计拿到监测点ID，然后去监测记录表根据item_code分组未处理总数倒序排序去查询前4类接口

​			2、根据通用设计拿到监测点ID以及步骤1中拿到的item_code查询监测项表，获取对应的监测项名称，其中预警记录表中的item_code对应监测项表里的type

**请求参数**:

| **参数名称** | **参数说明**                                   | **请求类型** | **是否必须** | **数据类型** | **schema** |
| ------------ | ---------------------------------------------- | ------------ | ------------ | ------------ | ---------- |
| areaCode     | 行政区划code，默认为遂昌县的area_code          | query        | false        | string       |            |
| date         | 统计的日期，不填默认为当天,日期格式:yyyy-MM-dd | query        | false        | string       |            |

**响应状态**:

| **状态码** | **说明**     | **schema**                    |
| ---------- | ------------ | ----------------------------- |
| 200        | OK           | 统一结果对象«List«MonitorVO»» |
| 401        | Unauthorized |                               |
| 403        | Forbidden    |                               |
| 404        | Not Found    |                               |

**响应参数**:

| **参数名称** | **参数说明**             | **类型**       | **schema**     |
| ------------ | ------------------------ | -------------- | -------------- |
| code         | 错误码（200为成功）      | integer(int32) | integer(int32) |
| data         | 响应数据对象             | array          | MonitorVO      |
| date         | 事件发生日期             | string         |                |
| monitorName  | 预警前四类监测项名称     | string         |                |
| monitorSum   | 预警前四类监测项告警次数 | integer(int64) |                |
| monitorType  | 预警前四类监测项类型     | string         |                |
| msg          | 提示信息                 | string         |                |
| success      | 是否成功                 | boolean        |                |

**响应示例**:

{  "code": 200,  "data": [    {      "date": "0316",      "monitorName": "深部位移",      "monitorSum": 2000,      "monitorType": "L1_SW"    }  ],  "msg": "",  "success": true }

## 6、统计预警监测项类别前4类接口（当日）

**接口地址**:/suichang-monitor/monitor/top4-monitor-item

**请求方式**:GET

**请求数据类型**:application/x-www-form-urlencoded

**响应数据类型**:*/*

**接口描述**:<p>统计当日预警监测项数值排名前四监测项名称与数值，按降序排序输出（含地质灾害＋山塘水库）</p>

**设计**：1、根据通用设计拿到监测点ID，然后去监测记录表根据item_code分组总数倒序排序去查询前4类接口

​			2、根据通用设计拿到监测点ID以及步骤1中拿到的item_code查询监测项表，获取对应的监测项名称，其中预警记录表中的item_code对应监测项表里的type

**请求参数**:

| **参数名称** | **参数说明**                                   | **请求类型** | **是否必须** | **数据类型** | **schema** |
| ------------ | ---------------------------------------------- | ------------ | ------------ | ------------ | ---------- |
| areaCode     | 行政区划code，默认为遂昌县的area_code          | query        | false        | string       |            |
| date         | 统计的日期，不填默认为当天,日期格式:yyyy-MM-dd | query        | false        | string       |            |

**响应状态**:

| **状态码** | **说明**     | **schema**                    |
| ---------- | ------------ | ----------------------------- |
| 200        | OK           | 统一结果对象«List«MonitorVO»» |
| 401        | Unauthorized |                               |
| 403        | Forbidden    |                               |
| 404        | Not Found    |                               |

**响应参数**:

| **参数名称** | **参数说明**             | **类型**       | **schema**     |
| ------------ | ------------------------ | -------------- | -------------- |
| code         | 错误码（200为成功）      | integer(int32) | integer(int32) |
| data         | 响应数据对象             | array          | MonitorVO      |
| date         | 事件发生日期             | string         |                |
| monitorName  | 预警前四类监测项名称     | string         |                |
| monitorSum   | 预警前四类监测项告警次数 | integer(int64) |                |
| monitorType  | 预警前四类监测项类型     | string         |                |
| msg          | 提示信息                 | string         |                |
| success      | 是否成功                 | boolean        |                |

**响应示例**:

{  "code": 200,  "data": [    {      "date": "0316",      "monitorName": "深部位移",      "monitorSum": 2000,      "monitorType": "L1_SW"    }  ],  "msg": "",  "success": true }

## 7、查看相关监测项的告警列表接口，列表展示告警信息包括：位置、监测点、预警描述、告警等级，列表滚动展示

**接口地址**:/suichang-monitor/monitor/monitor-item-list

**请求方式**:GET

**请求数据类型**:application/x-www-form-urlencoded

**响应数据类型**:*/*

**接口描述**:<p>查看相关监测项的告警列表，列表展示告警信息包括：位置、监测点、监测项类型、预警描述、告警等级，列表滚动展示</p>

**设计**：1、根据通用设计拿到监测点ID，根据监测项类型，监测点id,分页查询预警记录表

​			2、拿到步骤1的记录里的监测点ID，从通用设计里拿到对应监测点和监测对象中的相关字段

**请求参数**:

| **参数名称** | **参数说明**                                                 | **请求类型** | **是否必须** | **数据类型**   | **schema** |
| ------------ | ------------------------------------------------------------ | ------------ | ------------ | -------------- | ---------- |
| pageNo       | 页码                                                         | query        | true         | integer(int32) |            |
| pageSize     | 页容量                                                       | query        | true         | integer(int32) |            |
| type         | 监测项类型，（这里含：地表位移（GP）、倾角（QJ）、雨量（YL）、泥(水)位（NW）） | query        | true         | string         |            |
| areaCode     | 行政区划code，默认为遂昌县的area_code                        | query        | false        | string         |            |
| date         | 统计的日期，不填默认为当天,日期格式:yyyy-MM-dd               | query        | false        | string         |            |

**响应状态**:

| **状态码** | **说明**     | **schema**                        |
| ---------- | ------------ | --------------------------------- |
| 200        | OK           | 统一结果对象«List«MonitorItemVO»» |
| 401        | Unauthorized |                                   |
| 403        | Forbidden    |                                   |
| 404        | Not Found    |                                   |

**响应参数**:

| **参数名称** | **参数说明**        | **类型**          | **schema**     |
| ------------ | ------------------- | ----------------- | -------------- |
| code         | 错误码（200为成功） | integer(int32)    | integer(int32) |
| data         | 响应数据对象        | array             | MonitorItemVO  |
| alarmDesc    | 预警描述            | string            |                |
| alarmLevel   | 告警等级            | string            |                |
| altitude     | 海拔                | string            |                |
| areaDetail   | 地理位置            | string            |                |
| latitude     | 纬度                | string            |                |
| longitude    | 经度                | string            |                |
| name         | 监测点名称          | string            |                |
| status       | 预警状态            | string            |                |
| triggerTime  | 预警时间            | string(date-time) |                |
| type         | 监测项类型          | string            |                |
| msg          | 提示信息            | string            |                |
| success      | 是否成功            | boolean           |                |

**响应示例**:

{  "code": 200,  "data": [    {      "alarmDesc": "触发了红色预警",      "alarmLevel": "red",      "altitude": 88.88,      "areaDetail": "位置",      "latitude": 31.248144,      "longitude": 121.458911,      "name": "桥梁对象",      "status": "todo",      "triggerTime": "2022-03-22 12:00:00",      "type": "GP"    }  ],  "msg": "",  "success": true }

## 8、统计红色告警总数、橙色告警总数、黄色告警总数、蓝色告警总数接口（当日）

**接口地址**:/suichang-monitor/monitor/alarm-level-list

**请求方式**:GET

**请求数据类型**:application/x-www-form-urlencoded

**响应数据类型**:*/*

**接口描述**:<p>统计当日红色告警总数、橙色告警总数、黄色告警总数、蓝色告警总数（含地质灾害＋山塘水库）</p>

**设计**：1、根据通用设计拿到监测点ID，通过case when语句一次性查询出每类警告的总数

**请求参数**:

| **参数名称** | **参数说明**                                   | **请求类型** | **是否必须** | **数据类型** | **schema** |
| ------------ | ---------------------------------------------- | ------------ | ------------ | ------------ | ---------- |
| areaCode     | 行政区划code，默认为遂昌县的area_code          | query        | false        | string       |            |
| date         | 统计的日期，不填默认为当天,日期格式:yyyy-MM-dd | query        | false        | string       |            |

**响应状态**:

| **状态码** | **说明**     | **schema**                 |
| ---------- | ------------ | -------------------------- |
| 200        | OK           | 统一结果对象«AlarmLevelVO» |
| 401        | Unauthorized |                            |
| 403        | Forbidden    |                            |
| 404        | Not Found    |                            |

**响应参数**:

| **参数名称**   | **参数说明**        | **类型**       | **schema**     |
| -------------- | ------------------- | -------------- | -------------- |
| code           | 错误码（200为成功） | integer(int32) | integer(int32) |
| data           | 响应数据对象        | AlarmLevelVO   | AlarmLevelVO   |
| blueAlarmSum   | 蓝色告警总数        | integer(int64) |                |
| date           | 预警发生日期        | string         |                |
| orangeAlarmSum | 橙色告警总数        | integer(int64) |                |
| redAlarmSum    | 红色告警总数        | integer(int64) |                |
| yellowAlarmSum | 黄色告警总数        | integer(int64) |                |
| msg            | 提示信息            | string         |                |
| success        | 是否成功            | boolean        |                |

**响应示例**:

{  "code": 200,  "data": {    "blueAlarmSum": 2000,    "date": "0316",    "orangeAlarmSum": 2000,    "redAlarmSum": 2000,    "yellowAlarmSum": 2000  },  "msg": "",  "success": true }

## 9、统计红色告警已处理数、橙色告警已处理数、黄色告警已处理数、蓝色告警已处理数接口(当日)

**接口地址**:/suichang-monitor/monitor/done-alarm-level-list

**请求方式**:GET

**请求数据类型**:application/x-www-form-urlencoded

**响应数据类型**:*/*

**接口描述**:<p>统计红色告警已处理数、橙色告警已处理数、黄色告警已处理数、蓝色告警已处理数接口(当日)</p>

**设计**：1、根据通用设计拿到监测点ID，通过case when语句一次性查询出每类警告的总数

**请求参数**:

| **参数名称** | **参数说明**                                   | **请求类型** | **是否必须** | **数据类型** | **schema** |
| ------------ | ---------------------------------------------- | ------------ | ------------ | ------------ | ---------- |
| areaCode     | 行政区划code，默认为遂昌县的area_code          | query        | false        | string       |            |
| date         | 统计的日期，不填默认为当天,日期格式:yyyy-MM-dd | query        | false        | string       |            |

**响应状态**:

| **状态码** | **说明**     | **schema**                 |
| ---------- | ------------ | -------------------------- |
| 200        | OK           | 统一结果对象«AlarmLevelVO» |
| 401        | Unauthorized |                            |
| 403        | Forbidden    |                            |
| 404        | Not Found    |                            |

**响应参数**:

| **参数名称**   | **参数说明**        | **类型**       | **schema**     |
| -------------- | ------------------- | -------------- | -------------- |
| code           | 错误码（200为成功） | integer(int32) | integer(int32) |
| data           | 响应数据对象        | AlarmLevelVO   | AlarmLevelVO   |
| blueAlarmSum   | 蓝色告警总数        | integer(int64) |                |
| date           | 预警发生日期        | string         |                |
| orangeAlarmSum | 橙色告警总数        | integer(int64) |                |
| redAlarmSum    | 红色告警总数        | integer(int64) |                |
| yellowAlarmSum | 黄色告警总数        | integer(int64) |                |
| msg            | 提示信息            | string         |                |
| success        | 是否成功            | boolean        |                |

**响应示例**:

{  "code": 200,  "data": {    "blueAlarmSum": 2000,    "date": "0316",    "orangeAlarmSum": 2000,    "redAlarmSum": 2000,    "yellowAlarmSum": 2000  },  "msg": "",  "success": true }

## 10、监测对象基本信息接口

**接口地址**:/suichang-monitor/monitor/monitor-object-info

**请求方式**:GET

**请求数据类型**:application/x-www-form-urlencoded

**响应数据类型**:*/*

**接口描述**:<p>查询监测对象基本信息，包括：监测对象名称，监测对象类型、监测对象位置、监测对象状态：设备在线及数量、设备离线及数量</p>

**设计**：1、根据通用设计拿到监测点ID，根据监测点设备表，查询设备在线和离线数量，其余字段从通用设计对象里获取

**请求参数**:

| **参数名称** | **参数说明**                          | **请求类型** | **是否必须** | **数据类型** | **schema** |
| ------------ | ------------------------------------- | ------------ | ------------ | ------------ | ---------- |
| name         | 监测对象名称                          | query        | true         | string       |            |
| areaCode     | 行政区划code，默认为遂昌县的area_code | query        | false        | string       |            |

**响应状态**:

| **状态码** | **说明**     | **schema**                        |
| ---------- | ------------ | --------------------------------- |
| 200        | OK           | 统一结果对象«MonitorObjectInfoVO» |
| 401        | Unauthorized |                                   |
| 403        | Forbidden    |                                   |
| 404        | Not Found    |                                   |

**响应参数**:

| **参数名称**     | **参数说明**        | **类型**            | **schema**          |
| ---------------- | ------------------- | ------------------- | ------------------- |
| code             | 错误码（200为成功） | integer(int32)      | integer(int32)      |
| data             | 响应数据对象        | MonitorObjectInfoVO | MonitorObjectInfoVO |
| altitude         | 海拔                | string              |                     |
| areaDetail       | 监测对象位置        | string              |                     |
| latitude         | 纬度                | string              |                     |
| longitude        | 经度                | string              |                     |
| name             | 监测对象名称        | string              |                     |
| offlineDeviceNum | 离线设备数量        | integer(int32)      |                     |
| onlineDeviceNum  | 在线设备数量        | integer(int32)      |                     |
| type             | 监测对象类型        | string              |                     |
| msg              | 提示信息            | string              |                     |
| success          | 是否成功            | boolean             |                     |

**响应示例**:

{  "code": 200,  "data": {    "altitude": 88.88,    "areaDetail": "上海",    "latitude": 31.248144,    "longitude": 121.458911,    "name": "桥梁对象",    "offlineDeviceNum": 11,    "onlineDeviceNum": 10,    "type": "dzzh"  },  "msg": "",  "success": true }

## 11、告警信息：告警类型、位置、监测点、预警描述、处置状态接口（当日）

**接口地址**:/suichang-monitor/monitor/today-alarm-info

**请求方式**:GET

**请求数据类型**:application/x-www-form-urlencoded

**响应数据类型**:*/*

**接口描述**:<p>查询当日告警信息：包括告警类型、位置、监测点、预警描述、处置状态（含地质灾害＋山塘水库）</p>

**设计**：1、根据通用设计拿到监测点ID，根据监测点以及监测项类型，分页查询预警记录表

​			2、根据预警记录列表，拿到预警记录id的集合，然后去查询预警记录处理表，按时间倒序排列并根据记录ID分组，最终每条预警记录只拿到一条最新的预警记录处理信息。最终通过java组装信息返回

**请求参数**:

| **参数名称** | **参数说明**                                                 | **请求类型** | **是否必须** | **数据类型**   | **schema** |
| ------------ | ------------------------------------------------------------ | ------------ | ------------ | -------------- | ---------- |
| pageNo       | 页码                                                         | query        | true         | integer(int32) |            |
| pageSize     | 页容量                                                       | query        | true         | integer(int32) |            |
| type         | 监测项类型，（这里含：地表位移（GP）、倾角（QJ）、雨量（YL）、泥(水)位（NW）） | query        | true         | string         |            |
| areaCode     | 行政区划code，默认为遂昌县的area_code                        | query        | false        | string         |            |
| date         | 统计的日期，不填默认为当天,日期格式:yyyy-MM-dd               | query        | false        | string         |            |

**响应状态**:

| **状态码** | **说明**     | **schema**                      |
| ---------- | ------------ | ------------------------------- |
| 200        | OK           | 统一结果对象«List«AlarmInfoVO»» |
| 401        | Unauthorized |                                 |
| 403        | Forbidden    |                                 |
| 404        | Not Found    |                                 |

**响应参数**:

| **参数名称** | **参数说明**        | **类型**          | **schema**     |
| ------------ | ------------------- | ----------------- | -------------- |
| code         | 错误码（200为成功） | integer(int32)    | integer(int32) |
| data         | 响应数据对象        | array             | AlarmInfoVO    |
| alarmDate    | 预警时间            | string(date-time) |                |
| alarmDesc    | 预警描述            | string            |                |
| alarmLevel   | 告警等级            | string            |                |
| altitude     | 海拔                | string            |                |
| areaDetail   | 地理位置            | string            |                |
| date         | 查询时间            | string            |                |
| latitude     | 纬度                | string            |                |
| longitude    | 经度                | string            |                |
| name         | 监测点名称          | string            |                |
| processDate  | 处理时间            | string(date-time) |                |
| processUser  | 处理人              | string            |                |
| status       | 预警状态            | string            |                |
| msg          | 提示信息            | string            |                |
| success      | 是否成功            | boolean           |                |

**响应示例**:

{  "code": 200,  "data": [    {      "alarmDate": "2022-03-05 12:00:00",      "alarmDesc": "触发了红色预警",      "alarmLevel": "red",      "altitude": 88.88,      "areaDetail": "位置",      "date": "0316",      "latitude": 31.248144,      "longitude": 121.458911,      "name": "桥梁对象",      "processDate": "2022-03-06 12:00:00",      "processUser": "小李",      "status": "todo"    }  ],  "msg": "",  "success": true }

## 12、告警处理详情接口：含测点名称、预警时间、预警等级、监测项、预警描述、是否误报、处理意见、处理人、处理时间

**接口地址**:/suichang-monitor/monitor/alarm-detail

**请求方式**:GET

**请求数据类型**:application/x-www-form-urlencoded

**响应数据类型**:*/*

**接口描述**:<p>查询某个告警信息处理详情：包括测点名称、预警时间、预警等级、监测项、预警描述、是否误报、处理意见、处理人、处理时间</p>

**设计**：1、根据recordId查询预警记录表信息以及预警处理记录表相关信息

​			2、根据步骤1中的结果拿到监测点ID

​			3、去通用设计中根据监测点ID获取监测点相关信息

​		

**请求参数**:

| **参数名称** | **参数说明** | **请求类型** | **是否必须** | **数据类型** | **schema** |
| ------------ | ------------ | ------------ | ------------ | ------------ | ---------- |
| recordId     | 预警记录id   | query        | true         | string       |            |

**响应状态**:

| **状态码** | **说明**     | **schema**                  |
| ---------- | ------------ | --------------------------- |
| 200        | OK           | 统一结果对象«AlarmDetailVO» |
| 401        | Unauthorized |                             |
| 403        | Forbidden    |                             |
| 404        | Not Found    |                             |

**响应参数**:

| **参数名称**  | **参数说明**        | **类型**          | **schema**     |
| ------------- | ------------------- | ----------------- | -------------- |
| code          | 错误码（200为成功） | integer(int32)    | integer(int32) |
| data          | 响应数据对象        | AlarmDetailVO     | AlarmDetailVO  |
| alarmDesc     | 预警描述            | string            |                |
| alarmLevel    | 告警等级            | string            |                |
| falsePositive | 是否误报            | boolean           |                |
| gmtCreate     | 处理时间            | string(date-time) |                |
| name          | 监测点名称          | string            |                |
| opinions      | 处理意见            | string            |                |
| processUser   | 处理人              | string            |                |
| status        | 预警状态            | string            |                |
| triggerTime   | 预警时间            | string(date-time) |                |
| type          | 监测项类型          | string            |                |
| msg           | 提示信息            | string            |                |
| success       | 是否成功            | boolean           |                |

**响应示例**:

{  "code": 200,  "data": {    "alarmDesc": "触发了红色预警",    "alarmLevel": "red",    "falsePositive": false,    "gmtCreate": "2022-03-22 12:00:00",    "name": "桥梁对象",    "opinions": "good",    "processUser": "李四",    "status": "todo",    "triggerTime": "2022-03-22 12:00:00",    "type": "GP"  },  "msg": "",  "success": true }

## 13、查询近7日监测点的预警详情接口

**接口地址**:/suichang-monitor/monitor/day7-alarm-detail

**请求方式**:GET

**请求数据类型**:application/x-www-form-urlencoded

**响应数据类型**:*/*

**接口描述**:<p>查询近7日监测点的预警详情接口：包括地质灾害和山塘水库，查询条件分为全部（未处理+已处理）、未处理、已处理</p>

**设计**：1、从通用设计中获取所有监测点ID

​			2、根据监测点ID以及7天时间范围查询预警记录接口

​			3、拿到的结果集根据监测点ID和通用设计中的对象做关联，获取对应字段

**请求参数**:

| **参数名称** | **参数说明**                                        | **请求类型** | **是否必须** | **数据类型** | **schema** |
| ------------ | --------------------------------------------------- | ------------ | ------------ | ------------ | ---------- |
| areaCode     | 行政区划code，默认为遂昌县的area_code               | query        | false        | string       |            |
| date         | 统计的日期，不填默认为当天,日期格式:yyyy-MM-dd      | query        | false        | string       |            |
| status       | 预警处理状态：不传为全部，todo:未处理，done：已处理 | query        | false        | string       |            |

**响应状态**:

| **状态码** | **说明**     | **schema**                        |
| ---------- | ------------ | --------------------------------- |
| 200        | OK           | 统一结果对象«List«MonitorItemVO»» |
| 401        | Unauthorized |                                   |
| 403        | Forbidden    |                                   |
| 404        | Not Found    |                                   |

**响应参数**:

| **参数名称** | **参数说明**        | **类型**          | **schema**     |
| ------------ | ------------------- | ----------------- | -------------- |
| code         | 错误码（200为成功） | integer(int32)    | integer(int32) |
| data         | 响应数据对象        | array             | MonitorItemVO  |
| alarmDesc    | 预警描述            | string            |                |
| alarmLevel   | 告警等级            | string            |                |
| altitude     | 海拔                | string            |                |
| areaDetail   | 地理位置            | string            |                |
| latitude     | 纬度                | string            |                |
| longitude    | 经度                | string            |                |
| name         | 监测点名称          | string            |                |
| status       | 预警状态            | string            |                |
| triggerTime  | 预警时间            | string(date-time) |                |
| type         | 监测项类型          | string            |                |
| msg          | 提示信息            | string            |                |
| success      | 是否成功            | boolean           |                |

**响应示例**:

{  "code": 200,  "data": [    {      "alarmDesc": "触发了红色预警",      "alarmLevel": "red",      "altitude": 88.88,      "areaDetail": "位置",      "latitude": 31.248144,      "longitude": 121.458911,      "name": "桥梁对象",      "status": "todo",      "triggerTime": "2022-03-22 12:00:00",      "type": "GP"    }  ],  "msg": "",  "success": true }

## 14、统计近7天，每日红、橙、黄、蓝四级预警数量接口

**接口地址**:/suichang-monitor/monitor/day7-alarm-list

**请求方式**:GET

**请求数据类型**:application/x-www-form-urlencoded

**响应数据类型**:*/*

**接口描述**:<p>统计近7天，每天红色告警总数、橙色告警总数、黄色告警总数、蓝色告警总数（含地质灾害＋山塘水库）</p>

**设计**：1、根据通用设计拿到监测点ID，通过case when语句一次性查询出每类警告的总数

​			

**请求参数**:

| **参数名称** | **参数说明**                                   | **请求类型** | **是否必须** | **数据类型** | **schema** |
| ------------ | ---------------------------------------------- | ------------ | ------------ | ------------ | ---------- |
| areaCode     | 行政区划code，默认为遂昌县的area_code          | query        | false        | string       |            |
| date         | 统计的日期，不填默认为当天,日期格式:yyyy-MM-dd | query        | false        | string       |            |

**响应状态**:

| **状态码** | **说明**     | **schema**                       |
| ---------- | ------------ | -------------------------------- |
| 200        | OK           | 统一结果对象«List«AlarmLevelVO»» |
| 401        | Unauthorized |                                  |
| 403        | Forbidden    |                                  |
| 404        | Not Found    |                                  |

**响应参数**:

| **参数名称**   | **参数说明**        | **类型**       | **schema**     |
| -------------- | ------------------- | -------------- | -------------- |
| code           | 错误码（200为成功） | integer(int32) | integer(int32) |
| data           | 响应数据对象        | array          | AlarmLevelVO   |
| blueAlarmSum   | 蓝色告警总数        | integer(int64) |                |
| date           | 预警发生日期        | string         |                |
| orangeAlarmSum | 橙色告警总数        | integer(int64) |                |
| redAlarmSum    | 红色告警总数        | integer(int64) |                |
| yellowAlarmSum | 黄色告警总数        | integer(int64) |                |
| msg            | 提示信息            | string         |                |
| success        | 是否成功            | boolean        |                |

**响应示例**:

{  "code": 200,  "data": [    {      "blueAlarmSum": 2000,      "date": "0316",      "orangeAlarmSum": 2000,      "redAlarmSum": 2000,      "yellowAlarmSum": 2000    }  ],  "msg": "",  "success": true }

## 15、统计近七日红色告警已处理数、橙色告警已处理数、黄色告警已处理数、蓝色告警已处理数接口(当日)

**接口地址**:/suichang-monitor/monitor/day7-done-alarm-list

**请求方式**:GET

**请求数据类型**:application/x-www-form-urlencoded

**响应数据类型**:*/*

**接口描述**:<p>统计红色告警已处理数、橙色告警已处理数、黄色告警已处理数、蓝色告警已处理数接口(当日)</p>

**设计**：1、根据通用设计拿到监测点ID，状态为已处理，通过case when语句一次性查询出每类警告的总数

​			

**请求参数**:

| **参数名称** | **参数说明**                                   | **请求类型** | **是否必须** | **数据类型** | **schema** |
| ------------ | ---------------------------------------------- | ------------ | ------------ | ------------ | ---------- |
| areaCode     | 行政区划code，默认为遂昌县的area_code          | query        | false        | string       |            |
| date         | 统计的日期，不填默认为当天,日期格式:yyyy-MM-dd | query        | false        | string       |            |

**响应状态**:

| **状态码** | **说明**     | **schema**                       |
| ---------- | ------------ | -------------------------------- |
| 200        | OK           | 统一结果对象«List«AlarmLevelVO»» |
| 401        | Unauthorized |                                  |
| 403        | Forbidden    |                                  |
| 404        | Not Found    |                                  |

**响应参数**:

| **参数名称**   | **参数说明**        | **类型**       | **schema**     |
| -------------- | ------------------- | -------------- | -------------- |
| code           | 错误码（200为成功） | integer(int32) | integer(int32) |
| data           | 响应数据对象        | array          | AlarmLevelVO   |
| blueAlarmSum   | 蓝色告警总数        | integer(int64) |                |
| date           | 预警发生日期        | string         |                |
| orangeAlarmSum | 橙色告警总数        | integer(int64) |                |
| redAlarmSum    | 红色告警总数        | integer(int64) |                |
| yellowAlarmSum | 黄色告警总数        | integer(int64) |                |
| msg            | 提示信息            | string         |                |
| success        | 是否成功            | boolean        |                |

**响应示例**:

{  "code": 200,  "data": [    {      "blueAlarmSum": 2000,      "date": "0316",      "orangeAlarmSum": 2000,      "redAlarmSum": 2000,      "yellowAlarmSum": 2000    }  ],  "msg": "",  "success": true }

## 16、对今天，本周、本月，返回三个巡检次数进行统计；返回巡检结果中正常巡检的百分比（分别计算今日、本周、本月）

**接口地址**:/suichang-monitor/monitor/query-inspection-statistics

**请求方式**:GET

**请求数据类型**:application/x-www-form-urlencoded

**响应数据类型**:*/*

**接口描述**:<p>对巡检次数按三个进行统计，分别是今天，本周、本月，返回三个数值；返回巡检结果中正常巡检的百分比（分别计算今日、本周、本月）</p>

**请求参数**:

| **参数名称** | **参数说明**                          | **请求类型** | **是否必须** | **数据类型** | **schema** |
| ------------ | ------------------------------------- | ------------ | ------------ | ------------ | ---------- |
| areaCode     | 行政区划code，默认为遂昌县的area_code | query        | false        | string       |            |

**响应状态**:

| **状态码** | **说明**     | **schema**                                        |
| ---------- | ------------ | ------------------------------------------------- |
| 200        | OK           | 统一结果对象«List«MonitorInspectionStatisticsVO»» |
| 401        | Unauthorized |                                                   |
| 403        | Forbidden    |                                                   |
| 404        | Not Found    |                                                   |

**响应参数**:

| **参数名称**    | **参数说明**        | **类型**       | **schema**                    |
| --------------- | ------------------- | -------------- | ----------------------------- |
| code            | 错误码（200为成功） | integer(int32) | integer(int32)                |
| data            | 响应数据对象        | array          | MonitorInspectionStatisticsVO |
| inspectionCount |                     | integer(int64) |                               |
| normalCount     |                     | integer(int64) |                               |
| normalRate      |                     | number         |                               |
| timeScale       |                     | string         |                               |
| msg             | 提示信息            | string         |                               |
| success         | 是否成功            | boolean        |                               |

**响应示例**:

{  "code": 200,  "data": [    {      "inspectionCount": 0,      "normalCount": 0,      "normalRate": 0,      "timeScale": ""    }  ],  "msg": "",  "success": true }

## 17、查询当前所有离线设备，并在地图上显示设备名称及位置信息

**接口地址**:/suichang-monitor/monitor/query-offline-device

**请求方式**:GET

**请求数据类型**:application/x-www-form-urlencoded

**响应数据类型**:*/*

**接口描述**:<p>查询当前所有离线设备，并在地图上显示设备名称及位置信息</p>

**设计**：1、根据通用设计拿到监测点ID，根据监测点设备表，查询设备离线信息，其余字段从通用设计对象里获取

**请求参数**:

| **参数名称** | **参数说明**                          | **请求类型** | **是否必须** | **数据类型** | **schema** |
| ------------ | ------------------------------------- | ------------ | ------------ | ------------ | ---------- |
| areaCode     | 行政区划code，默认为遂昌县的area_code | query        | false        | string       |            |

**响应状态**:

| **状态码** | **说明**     | **schema**                          |
| ---------- | ------------ | ----------------------------------- |
| 200        | OK           | 统一结果对象«List«OfflineDeviceVO»» |
| 401        | Unauthorized |                                     |
| 403        | Forbidden    |                                     |
| 404        | Not Found    |                                     |

**响应参数**:

| **参数名称** | **参数说明**        | **类型**       | **schema**      |
| ------------ | ------------------- | -------------- | --------------- |
| code         | 错误码（200为成功） | integer(int32) | integer(int32)  |
| data         | 响应数据对象        | array          | OfflineDeviceVO |
| latitude     | 离线监测点纬度      | string         |                 |
| longitude    | 离线监测点经度      | string         |                 |
| name         | 离线监测点名称      | string         |                 |
| msg          | 提示信息            | string         |                 |
| success      | 是否成功            | boolean        |                 |

**响应示例**:

{  "code": 200,  "data": [    {      "latitude": 31.248144,      "longitude": 121.458911,      "name": "监测点1"    }  ],  "msg": "",  "success": true }

## 18、查询当日所有的报警监测点（非监测对象），并返回最新的预警信息（如有多条报警信息，返回最后一次报警结果），包括：监测点名称、预警时间、预警等级、监测项、预警描述、处置状态、位置、是否误报、处理意见、处理人、处理时间。

**接口地址**:/suichang-monitor/monitor/query-alarm-point

**请求方式**:GET

**请求数据类型**:application/x-www-form-urlencoded

**响应数据类型**:*/*

**接口描述**:<p>查询当日所有的报警监测点（非监测对象），并返回最新的预警信息（如有多条报警信息，返回最后一次报警结果），包括：监测点名称、预警时间、预警等级、监测项、预警描述、处置状态、位置、是否误报、处理意见、处理人、处理时间。</p>

**设计**：1、根据通用设计拿到监测点ID

​			2、根据监测点ID查询预警记录表，为了拿到最新一条，需要对trigger_time倒序排列，并对监测点ID进行group by分组，

查询条件限制在当日

​			3、拿到的结果集和通用设计对象关联拿到其它字段信息

**请求参数**:

| **参数名称** | **参数说明**                                   | **请求类型** | **是否必须** | **数据类型** | **schema** |
| ------------ | ---------------------------------------------- | ------------ | ------------ | ------------ | ---------- |
| areaCode     | 行政区划code，默认为遂昌县的area_code          | query        | false        | string       |            |
| date         | 统计的日期，不填默认为当天,日期格式:yyyy-MM-dd | query        | false        | string       |            |

**响应状态**:

| **状态码** | **说明**     | **schema**                           |
| ---------- | ------------ | ------------------------------------ |
| 200        | OK           | 统一结果对象«List«AlarmPointInfoVO»» |
| 401        | Unauthorized |                                      |
| 403        | Forbidden    |                                      |
| 404        | Not Found    |                                      |

**响应参数**:

| **参数名称**  | **参数说明**        | **类型**          | **schema**       |
| ------------- | ------------------- | ----------------- | ---------------- |
| code          | 错误码（200为成功） | integer(int32)    | integer(int32)   |
| data          | 响应数据对象        | array             | AlarmPointInfoVO |
| alarmDesc     | 预警描述            | string            |                  |
| alarmLevel    | 告警等级            | string            |                  |
| falsePositive | 是否误报            | boolean           |                  |
| gmtCreate     | 处理时间            | string(date-time) |                  |
| itemCode      | 监测项类型          | string            |                  |
| latitude      | 监测点纬度          | string            |                  |
| longitude     | 监测点经度          | string            |                  |
| opinions      | 处理意见            | string            |                  |
| pointName     | 监测点名称          | string            |                  |
| processUser   | 处理人              | string            |                  |
| status        | 预警状态            | string            |                  |
| triggerTime   | 预警时间            | string(date-time) |                  |
| msg           | 提示信息            | string            |                  |
| success       | 是否成功            | boolean           |                  |

**响应示例**:

{  "code": 200,  "data": [    {      "alarmDesc": "触发了红色预警",      "alarmLevel": "red",      "falsePositive": false,      "gmtCreate": "0316",      "itemCode": "L1_SW",      "latitude": 31.248144,      "longitude": 121.458911,      "opinions": "good",      "pointName": "桥梁对象",      "processUser": "李四",      "status": "todo",      "triggerTime": "0315"    }  ],  "msg": "",  "success": true }

## 19、查询近7日每日某监测项告警事件总数

**接口地址**:/suichang-monitor/monitor/day7-alarm-event-count

**请求方式**:GET

**请求数据类型**:application/x-www-form-urlencoded

**响应数据类型**:*/*

**接口描述**:<p>查询近7日每日某监测项告警事件总数、每日某监测项告警事件未处理总数、每日某监测项告警事件已处理总数。包括地质灾害和山塘水库。</p>

**设计**：1、根据通用设计拿到监测点ID

​			2、根据监测点ID、监测类型、触发事件获取给定日期范围的监测项告警事件总数，以下是相关s q l

```
select    DATE_FORMAT(trigger_time,'%Y-%m-%d') AS date ,    count(*) AS total,    count(case status when 'todo' then 1 end) AS todoCount,    count(case status when 'done' then 1 end) AS doneCountfrom notice_alarm_record narwhere point_id in (#{param.pointIds})and item_code =#{param.type}and trigger_time between #{param.startDate} and #{param.endDate}group by date
```

**请求参数**:

| **参数名称** | **参数说明**                                                 | **请求类型** | **是否必须** | **数据类型** | **schema** |
| ------------ | ------------------------------------------------------------ | ------------ | ------------ | ------------ | ---------- |
| type         | 监测项类型，（这里含：地表位移（GP）、倾角（QJ）、雨量（YL）、泥(水)位（NW）） | query        | true         | string       |            |
| areaCode     | 行政区划code，默认为遂昌县的area_code                        | query        | false        | string       |            |
| date         | 统计的日期，不填默认为当天,日期格式:yyyy-MM-dd               | query        | false        | string       |            |

**响应状态**:

| **状态码** | **说明**     | **schema**                     |
| ---------- | ------------ | ------------------------------ |
| 200        | OK           | 统一结果对象«List«WarnItemVO»» |
| 401        | Unauthorized |                                |
| 403        | Forbidden    |                                |
| 404        | Not Found    |                                |

**响应参数**:

| **参数名称** | **参数说明**               | **类型**       | **schema**     |
| ------------ | -------------------------- | -------------- | -------------- |
| code         | 错误码（200为成功）        | integer(int32) | integer(int32) |
| data         | 响应数据对象               | array          | WarnItemVO     |
| date         | 事件发生日期               | string         |                |
| doneCount    | 某监测项告警事件已处理总数 | integer(int32) |                |
| todoCount    | 某监测项告警事件未处理总数 | integer(int32) |                |
| totalCount   | 某监测项告警事件总数       | integer(int32) |                |
| msg          | 提示信息                   | string         |                |
| success      | 是否成功                   | boolean        |                |

**响应示例**:

{  "code": 200,  "data": [    {      "date": "2022-03-22",      "doneCount": 100,      "todoCount": 100,      "totalCount": 100    }  ],  "msg": "",  "success": true }